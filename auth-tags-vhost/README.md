# Authentication, User Tags and Vhost access

We expand on the previous scenario, [Authentication and Tags](../authentication-and-tags/README.md), but this time we are going to configure which users get access to which vhosts.

These are our requirements for this scenario:

- In our `dc=example, dc=com` organization we have 3 environments: **dev**, **qa** and **prod**. Each environment matches one RabbitMQ vhost.
- `bob` can view all vhosts via the management plugin however it does not have AMQP access to any vhost. Similarly occurs with `prometheus`.
- Users can be assigned to one or many env/vhost. This allows them to access any AMQP resource (exchange, queue) on the corresponding vhost. For instance, we are going to grant `app100` user access to `dev` vhost and `app200` access to `prod` vhost.

From the [docs](http://www.rabbitmq.com/access-control.html#permissions):

> When a RabbitMQ client establishes a connection to a server, it specifies a virtual host within which it intends to operate. A first level of access control is enforced at this point, with the server checking whether the user has any permissions to access the virtual hosts, and rejecting the connection attempt otherwise.

## 1. Launch OpenLDAP

From within `auth-tags-vhost` folder, run `start.sh` script to launch **OpenLDAP**. It will kill the container we ran on the previous scenario and it will start a new one. This is so that we start with a clean LDAP database.

## 2. Set up LDAP entries

1. We are going to expand the LDAP structure we used in the [previous scenario](../authentication-and-tags/Readme.md).
2. We are adding 2 more users : `app100` and `app200`. These 2 users have no management plugin access
3. `app100` is granted access to `dev` vhost and `app200` is granted access to `prod` vhost

```
          dc=example, dc=com
                  |
          +-------+---------+----------------------------------------+
          |                 |                                        |
   cn=admin,            ou=env,                                   ou=People
    dc=example,          dc=example,                               dc=example,
    dc=com               dc=com                                    dc=com
                            |                                        |
  +---------------+---------+-+                              +-------+--------------+
  |               |           |                              |                      |
ou=dev         ou=qa        ou=prod                         cn=app100      .......   
 ou=env,        ou=env,      ou=env,                         ou=People,
 dc=example,    dc=example,  dc=example,                     dc=example,
 dc=com         dc=com       dc=com                       
  ||                           ||                         
  ||                           ||                         
------                       ------                       
cn=app100,..                 cn=app200,...

```

Run the following command to create this structure:   

```
./auth-tags-vhost/import.sh
```

Run the following command to create the vhosts:  

```
./auth-tags-vhost/create-vhosts.sh
```

Vhosts must exist in RabbitMQ whereas users and their permissions don't because they are defined in LDAP.

### 3. Configure RabbitMQ to authenticate users with our LDAP server and grant administrator and monitoring user tags

Edit your `rabbimq.config`, add the following configuration and restart RabbitMQ:

```
[
    {rabbit, [
        {auth_backends, [rabbit_auth_backend_ldap]}
    ]},
    {rabbitmq_auth_backend_ldap, [

        {servers,            ["localhost"]},
        {user_dn_pattern,    "cn=${username},ou=People,dc=example,dc=com"},
        {other_bind,         {"cn=admin,dc=example,dc=com", "admin"}},
        {tag_queries, [
            {administrator,  {in_group, "cn=administrator,ou=groups,dc=example,dc=com", "uniqueMember"}},
            {monitoring,     {in_group, "cn=monitoring,ou=groups,dc=example,dc=com", "uniqueMember"}}
        ]},
        {vhost_access_query, {in_group, "cn=${vhost},ou=env,dc=example,dc=com", "uniqueMember"}},
        {log, network}
    ]}
].
```

This same configuration is available in the file [rabbitmq.config](rabbitmq.config) should you want to copy files.

**Configuration explained**:

- The only thing we have added is the `vhost_access_query` which is checked by RabbitMQ when we login via AMQP. It is implemented so that the logged user must be a member of the group which matches the `vhost` name.
  > In PCF, vhost's names are not user-friendly and they are generated by the Tile, not by the end user. For some customers this is an issue because they dont want to have unfriendly names in their LDAP, or at least in the entries' DN.


### 4. Verify Configuration

1. Make sure that `app100` can access via AMQP to the vhost `dev`
    ```
    ruby app100.rb dev
    ```
2. Make sure that `app100` **cannot** access via AMQP to the vhost `prod`
    ```
    ruby app100.rb prod
    ```
3. Make sure that `app200` can access via AMQP to the vhost `prod`
    ```
    ruby app200.rb prod
    ```
4. Make sure that `app100` cannot access the management plugin
    ```
    curl -u app100:password http://localhost:15672/api/overview`
    ```
    Shall produce:
    ```
    {"error":"not_authorised","reason":"Not management user"}
    ```
