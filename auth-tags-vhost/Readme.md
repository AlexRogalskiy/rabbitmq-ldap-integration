# Authentication, User Tags and Vhost access

We expand on the previous scenario, [Authentication and Tags](../authentication-and-tags/Readme.md), but this time we are going to configure which users get access which which vhosts.

These are our requirements for this scenario:
- In our `dc=example, dc=com` organization we have typically 3 environments: **dev**, **qa** and **prod**. Each environment matches with one rabbitmq vhost.
- Users in the `administrator` and `monitoring` groups are allowed to access any vhost.
- Users can be assigned to one or many env/vhost. This allows them to access any AMQP resource (exchange, queue) on the corresponding vhost.


## 1. Launch OpenLDPA

Run `start.sh` script to launch **OpenLdap**. It will kill the container we ran on the previous scenario and it will start a new one. This is so that we start with a clean LDAP database.

## 2. Set up LDAP entries

1. We are going to expand the LDAP structure we used in the [previous scenario](../authentication-and-tags/Readme.md).
2. We are adding 2 more users : `app100` and `app200`. These 2 users have no management plugin access
3. `app100` is granted access to `dev` vhost and `app200` is granted access to `prod` vhost

```
          dc=example, dc=com
                  |
          +-------+---------+----------------------------------------+
          |                 |                                        |
   cn=admin,            ou=env,                                   ou=People
    dc=example,          dc=example,                               dc=example,
    dc=com               dc=com                                    dc=com
                            |                                        |
  +---------------+---------+-+                              +-------+--------------+
  |               |           |                              |                      |
ou=dev         ou=qa        ou=prod                         cn=app100      .......   
 ou=env,        ou=env,      ou=env,                         ou=People,
 dc=example,    dc=example,  dc=example,                     dc=example,
 dc=com         dc=com       dc=com                       
  ||                           ||                         
  ||                           ||                         
------                       ------                       
cn=app100,..                 cn=app200,...


```

Run the following command to create this structure:   
`./import.sh`

Run the following command to create the vhosts:  
`./create-vhosts.sh`
> Vhosts must exist in RabbitMQ whereas users and their permissions don't because they are defined in LDAP.


### 3. Configure RabbitMq to authenticate users with our LDAP server and grant administrator and monitoring user tags

Edit your **rabbimq.config**, add the following configuration and restart Rabbit:
```
[
    { rabbit,
      [
        {auth_backends, [rabbit_auth_backend_ldap]}
      ]
    },
    { rabbitmq_auth_backend_ldap,
      [
        {servers,               ["localhost"] },
        {user_dn_pattern,       "cn=${username},ou=People,dc=example,dc=com"},

        {other_bind,            { "cn=admin,dc=example,dc=com", "admin"  } },
        {tag_queries, [
               {administrator,  { in_group, "cn=administrator,ou=groups,dc=example,dc=com" , "uniqueMember" }},
               {monitoring,     { in_group, "cn=monitoring,ou=groups,dc=example,dc=com" , "uniqueMember" }}
               ]
        },
        {vhost_access_query,    { in_group, "cn=${vhost},ou=env,dc=example,dc=com", "uniqueMember" }},
        {log, network}

      ]
    }
].
```


**Configuration explained**:
- The only thing we have added is the `vhost_access_query` which is checked by rabbitmq when we login via AMQP. It is implemented so that the logged user must be a member of the group which matches the `vhost` name.
  > In PCF, vhost's names are not user-friendly and they are generated by the Tile, not by the end user. For some customers this is an issue because they dont want to have unfriendly names in their LDAP, or at least in the entries' DN.


### 4. Verify Configuration

1. Make sure that `app100` can access via AMQP to the vhost `dev`
  `bin/runjava com.rabbitmq.perf.PerfTest --uri amqp://app100:password@localhost:5672/dev`
2. Make sure that `app100` cannot access via AMQP to the vhost `prod`
  `bin/runjava com.rabbitmq.perf.PerfTest --uri amqp://app100:password@localhost:5672/prod`
    > Caused by: com.rabbitmq.client.ShutdownSignalException: connection error; protocol method: #method<connection.close>(reply-code=530, reply-text=NOT_ALLOWED - access to vhost 'prod' refused for user 'app100', class-id=10, method-id=40)

3. Make sure that `app200` can access via AMQP to the vhost `prod`
  `bin/runjava com.rabbitmq.perf.PerfTest --uri amqp://app200:password@localhost:5672/prod`
4. Make sure that `app100` cannot access the management plugin
  `curl -u app100:password http://localhost:15672/api/overview`
    > {"error":"not_authorised","reason":"Not management user"}
